<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Fitness Trainer</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF Autotable for tables in PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Lighter background */
            color: #2d3748; /* Darker text for better contrast */
        }
        .container {
            max-width: 1100px; /* Slightly wider container */
            margin: 0 auto;
            padding: 24px;
        }
        .tab-button {
            @apply flex-1 px-6 py-3 rounded-t-xl text-base font-semibold transition-all duration-300 ease-in-out text-center;
            border-bottom: 3px solid transparent; /* For active state */
            white-space: nowrap; /* Prevent text wrapping */
            min-width: fit-content; /* Ensure button doesn't shrink too much */
        }
        .tab-button.active {
            @apply bg-white text-blue-700 border-blue-600 shadow-md;
            border-bottom: 3px solid #3b82f6; /* Stronger active indicator */
        }
        .tab-button:not(.active) {
            @apply text-gray-600 hover:bg-gray-100 hover:text-blue-500;
        }
        /* For the tab container, ensure it can wrap */
        .flex.border-b-2 {
            flex-wrap: wrap; /* Allow tabs to wrap to next line on smaller screens */
            justify-content: center; /* Center tabs when they wrap */
        }
        .input-group {
            margin-bottom: 16px; /* Added vertical spacing for input groups */
        }
        .input-group label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .input-group input, .input-group select, .input-group textarea {
            @apply mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-base; /* Slightly larger padding and rounded corners */
        }
        .card {
            @apply bg-white p-8 rounded-xl shadow-lg mb-8; /* More padding, rounded, and stronger shadow */
        }
        .modal {
            @apply fixed inset-0 bg-gray-800 bg-opacity-60 flex items-center justify-center z-50; /* Darker overlay */
        }
        .modal-content {
            @apply bg-white p-10 rounded-xl shadow-2xl max-w-md w-full; /* Larger padding, more rounded, stronger shadow */
        }
        .modal-header {
            @apply flex justify-between items-center pb-4 border-b border-gray-200 mb-6; /* More spacing */
        }
        .modal-header h3 {
            @apply text-xl font-bold text-gray-900;
        }
        .modal-close-button {
            @apply text-gray-500 hover:text-gray-700 text-2xl; /* Larger close button */
        }
        .modal-footer {
            @apply pt-6 border-t border-gray-200 mt-6 flex justify-end; /* More spacing */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #22c55e;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Custom styles for BMI scale bar */
        #bmi-scale-bar {
            background: linear-gradient(to right,
                #facc15 0%, #facc15 18.5%, /* Underweight */
                #22c55e 18.5%, #22c55e 24.9%, /* Normal */
                #fbbf24 24.9%, #fbbf24 29.9%, /* Overweight */
                #ef4444 29.9%, #ef4444 34.9%, /* Obese I */
                #dc2626 34.9%, #dc2626 39.9%, /* Obese II */
                #b91c1c 39.9%, #b91c1c 100% /* Obese III */
            );
        }
        #bmi-pointer {
            transition: left 0.5s ease-out, background-color 0.5s ease-out;
            z-index: 10; /* Ensure pointer is above the bar and labels */
        }
        .bmi-label { /* New class for BMI scale labels */
            @apply absolute text-xs top-1/2 -translate-y-1/2 text-gray-800 font-semibold;
            background-color: rgba(255,255,255,0.7); /* Slightly transparent background for readability */
            padding: 2px 4px;
            border-radius: 4px;
        }
        /* Button specific styles for gradients and hover effects */
        .bg-blue-600 {
            background-image: linear-gradient(to right, #3b82f6, #2563eb);
            transition: all 0.2s ease-in-out;
        }
        .bg-blue-600:hover {
            background-image: linear-gradient(to right, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        .bg-green-600 {
            background-image: linear-gradient(to right, #10b981, #059669);
            transition: all 0.2s ease-in-out;
        }
        .bg-green-600:hover {
            background-image: linear-gradient(to right, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        .bg-purple-600 {
            background-image: linear-gradient(to right, #8b5cf6, #7c3aed);
            transition: all 0.2s ease-in-out;
        }
        .bg-purple-600:hover {
            background-image: linear-gradient(to right, #7c3aed, #6d28d9);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        .text-red-600 { /* For delete button */
            transition: all 0.2s ease-in-out;
        }
        .text-red-600:hover {
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <div class="container flex-grow">
        <h1 class="text-4xl font-extrabold text-center my-10 text-blue-800 tracking-tight">Personal Fitness Trainer</h1>

        <!-- User ID Display -->
        <div id="user-id-display" class="bg-blue-50 text-blue-800 p-4 rounded-lg text-sm mb-8 text-center border border-blue-200 shadow-sm">
            Your User ID: <span id="current-user-id" class="font-mono font-semibold text-blue-900">Loading...</span>
        </div>

        <!-- Tabs Navigation -->
        <div class="flex border-b-2 border-gray-200 mb-8 bg-white rounded-t-xl shadow-sm">
            <button class="tab-button active" data-tab="input">
                <i class="fas fa-user-edit mr-2"></i>User Profile
            </button>
            <button class="tab-button" data-tab="calculators">
                <i class="fas fa-calculator mr-2"></i>Calculators
            </button>
            <button class="tab-button" data-tab="progress">
                <i class="fas fa-chart-line mr-2"></i>Progress
            </button>
            <button class="tab-button" data-tab="reports">
                <i class="fas fa-file-pdf mr-2"></i>Reports
            </button>
            <button class="tab-button" data-tab="recommendations">
                <i class="fas fa-lightbulb mr-2"></i>Recommendations
            </button>
            <button class="tab-button" data-tab="personalized-plan">
                <i class="fas fa-dumbbell mr-2"></i>Personalized Plan
            </button>
        </div>

        <!-- Tab Content -->
        <div id="tab-content">
            <!-- User Input Tab -->
            <div id="input" class="tab-pane active">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Your Profile & Measurements</h2>
                    <form id="user-profile-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="input-group">
                            <label for="name">Name:</label>
                            <input type="text" id="name" placeholder="Your Name">
                        </div>
                        <div class="input-group">
                            <label for="age">Age:</label>
                            <input type="number" id="age" min="1" max="120" placeholder="e.g., 30">
                        </div>
                        <div class="input-group">
                            <label for="gender">Gender:</label>
                            <select id="gender">
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="units">Units:</label>
                            <select id="units">
                                <option value="metric">Metric (kg, cm)</option>
                                <option value="imperial">Imperial (lbs, inches)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="height">Height (<span id="height-unit">cm</span>):</label>
                            <input type="number" id="height" step="0.1" placeholder="e.g., 175">
                        </div>
                        <div class="input-group">
                            <label for="weight">Weight (<span id="weight-unit">kg</span>):</label>
                            <input type="number" id="weight" step="0.1" placeholder="e.g., 70">
                        </div>
                        <div class="input-group">
                            <label for="neck">Neck (<span id="neck-unit">cm</span>):</label>
                            <input type="number" id="neck" step="0.1" placeholder="e.g., 35">
                        </div>
                        <div class="input-group">
                            <label for="waist">Waist (<span id="waist-unit">cm</span>):</label>
                            <input type="number" id="waist" step="0.1" placeholder="e.g., 80">
                        </div>
                        <div class="input-group" id="hip-input-group">
                            <label for="hip">Hip (<span id="hip-unit">cm</span>):</label>
                            <input type="number" id="hip" step="0.1" placeholder="e.g., 90">
                        </div>
                        <div class="input-group">
                            <label for="activity-level">Activity Level:</label>
                            <select id="activity-level">
                                <option value="1.2">Sedentary (little or no exercise)</option>
                                <option value="1.375">Lightly active (light exercise/sports 1-3 days/week)</option>
                                <option value="1.55">Moderately active (moderate exercise/sports 3-5 days/week)</option>
                                <option value="1.725">Very active (hard exercise/sports 6-7 days a week)</option>
                                <option value="1.9">Extra active (very hard exercise/physical job)</option>
                            </select>
                        </div>
                        <!-- New Profile Fields -->
                        <div class="input-group">
                            <label for="occupation">Occupation:</label>
                            <input type="text" id="occupation" placeholder="e.g., Remote Worker">
                        </div>
                        <div class="input-group">
                            <label for="blood-type">Blood Type:</label>
                            <select id="blood-type">
                                <option value="">Select Blood Type</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="input-group lg:col-span-3">
                            <label for="fitness-goal">Fitness Goal:</label>
                            <textarea id="fitness-goal" rows="3" placeholder="e.g., Lose weight, build muscle, improve endurance..."></textarea>
                        </div>
                        <div class="input-group lg:col-span-3">
                            <label for="workout-constraints">Workout Constraints:</label>
                            <textarea id="workout-constraints" rows="3" placeholder="e.g., Limited gym access, knee pain, limited time..."></textarea>
                        </div>
                        <div class="input-group lg:col-span-3">
                            <label for="specific-concerns">Specific Concerns:</label>
                            <textarea id="specific-concerns" rows="3" placeholder="e.g., Lower back pain, poor flexibility, stress management..."></textarea>
                        </div>
                        <div class="input-group lg:col-span-3">
                            <label for="workout-preference">Workout Preference:</label>
                            <textarea id="workout-preference" rows="3" placeholder="e.g., Home workouts, gym, running, yoga..."></textarea>
                        </div>
                        <div class="input-group">
                            <label for="supplements-preference">Open to Supplements:</label>
                            <select id="supplements-preference">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                                <option value="maybe">Maybe (with research)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="workout-days">Workout Days per Week:</label>
                            <input type="number" id="workout-days" min="1" max="7" placeholder="e.g., 3">
                        </div>

                        <div class="lg:col-span-3 flex justify-end mt-4">
                            <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 ease-in-out shadow-md hover:shadow-lg">
                                <i class="fas fa-save mr-2"></i>Save Profile & Measurements
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Calculators Tab -->
            <div id="calculators" class="tab-pane hidden">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">BMI Calculation</h2>
                    <div class="mb-4 text-lg">
                        <p>Your BMI: <span id="bmi-result" class="font-bold text-blue-600">N/A</span></p>
                        <p>Classification: <span id="bmi-classification" class="font-bold">N/A</span></p>
                        <p>Health Risk: <span id="bmi-health-risk" class="font-bold">N/A</span></p>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-5 mb-4 relative overflow-hidden">
                        <div id="bmi-scale-bar" class="h-full rounded-full absolute" style="width: 100%;"></div>
                        <span class="bmi-label" style="left: calc(18.5% - 15px);">18.5</span>
                        <span class="bmi-label" style="left: calc(25% - 15px);">25</span>
                        <span class="bmi-label" style="left: calc(30% - 15px);">30</span>
                        <span class="bmi-label" style="left: calc(35% - 15px);">35</span>
                        <span class="bmi-label" style="left: calc(40% - 15px);">40</span>
                        <div id="bmi-pointer" class="absolute h-8 w-1.5 bg-red-500 -translate-x-1/2 top-1/2 -translate-y-1/2 rounded-full shadow-lg" style="left: 0%;"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-700 mt-2 font-medium">
                        <span>Underweight</span>
                        <span>Normal</span>
                        <span>Overweight</span>
                        <span>Obese</span>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Body Fat Percentage</h2>
                    <p class="mb-3 text-lg">Navy Method: <span id="body-fat-navy" class="font-bold text-blue-600">N/A</span></p>
                    <p class="mb-3 text-lg">Jackson-Pollock (Simulated): <span id="body-fat-jackson-pollock" class="font-bold text-blue-600">N/A</span></p>
                    <p class="mb-3 text-lg">BIA Simulation: <span id="body-fat-bia" class="font-bold text-blue-600">N/A</span></p>
                    <p class="text-sm text-gray-600 mt-5">
                        *Note: Jackson-Pollock and BIA methods are simulated based on general formulas and user input. For accurate results, professional measurements are recommended.
                    </p>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Ideal Weight Ranges</h2>
                    <p class="mb-3 text-lg">Hamwi Formula: <span id="ideal-weight-hamwi" class="font-bold text-blue-600">N/A</span></p>
                    <p class="mb-3 text-lg">Devine Formula: <span id="ideal-weight-devine" class="font-bold text-blue-600">N/A</span></p>
                    <p class="mb-3 text-lg">Robinson Formula: <span id="ideal-weight-robinson" class="font-bold text-blue-600">N/A</span></p>
                    <p class="mb-3 text-lg">Miller Formula: <span id="ideal-weight-miller" class="font-bold text-blue-600">N/A</span></p>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Calorie Needs Estimation</h2>
                    <h3 class="font-semibold mb-3 text-gray-700 text-lg">Basal Metabolic Rate (BMR):</h3>
                    <p class="mb-2 text-lg">Harris-Benedict Equation: <span id="bmr-harris-benedict" class="font-bold text-blue-600">N/A</span> kcal/day</p>
                    <p class="mb-2 text-lg">Mifflin-St Jeor Equation: <span id="bmr-mifflin-st-jeor" class="font-bold text-blue-600">N/A</span> kcal/day</p>
                    <p class="mb-4 text-lg">Katch-McArdle Equation: <span id="bmr-katch-mcardle" class="font-bold text-blue-600">N/A</span> kcal/day</p>
                    <h3 class="font-semibold mb-3 text-gray-700 text-lg">Total Daily Energy Expenditure (TDEE):</h3>
                    <p class="mb-2 text-lg">Estimated TDEE: <span id="tdee-result" class="font-bold text-blue-600">N/A</span> kcal/day</p>
                </div>
            </div>

            <!-- Progress Tab -->
            <div id="progress" class="tab-pane hidden">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Measurement History</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-sm border border-gray-200">
                            <thead>
                                <tr class="bg-gray-100 border-b border-gray-200">
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Weight</th>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">BMI</th>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Body Fat (%)</th>
                                    <th class="px-5 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="divide-y divide-gray-200">
                                <!-- History rows will be inserted here by JavaScript -->
                                <tr>
                                    <td colspan="5" class="px-5 py-4 text-center text-gray-500">No history available. Save your first measurement!</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Progress Charts</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="font-semibold mb-3 text-gray-700 text-lg">Weight Trend</h3>
                            <canvas id="weightChart"></canvas>
                        </div>
                        <div>
                            <h3 class="font-semibold mb-3 text-gray-700 text-lg">BMI Trend</h3>
                            <canvas id="bmiChart"></canvas>
                        </div>
                        <div>
                            <h3 class="font-semibold mb-3 text-gray-700 text-lg">Body Fat Trend</h3>
                            <canvas id="bodyFatChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-pane hidden">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Generate Report</h2>
                    <p class="mb-6 text-gray-700 text-lg">Click the button below to generate a PDF report of your current metrics and history, including your personalized plan if generated.</p>
                    <button id="generate-pdf-btn" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-all duration-300 ease-in-out shadow-md hover:shadow-lg">
                        <i class="fas fa-file-export mr-2"></i>Generate PDF Report
                    </button>
                </div>
            </div>

            <!-- Recommendations Tab -->
            <div id="recommendations" class="tab-pane hidden">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Personalized Health Recommendations</h2>
                    <div id="recommendations-content" class="prose max-w-none text-gray-700 leading-relaxed">
                        <p>Recommendations will appear here after you save your measurements and calculations are performed.</p>
                        <p>These recommendations are based on your BMI, Body Fat Percentage, Ideal Weight, and Calorie Needs. They provide general guidance and should not replace professional medical or fitness advice.</p>
                        <h3 class="text-xl font-semibold mt-8 mb-3 text-gray-800">General Guidance:</h3>
                        <ul class="list-disc list-inside space-y-2">
                            <li>Maintain a balanced diet rich in whole foods, lean proteins, fruits, and vegetables.</li>
                            <li>Engage in regular physical activity, aiming for at least 150 minutes of moderate-intensity exercise or 75 minutes of vigorous-intensity exercise per week.</li>
                            <li>Stay hydrated by drinking plenty of water throughout the day.</li>
                            <li>Prioritize adequate sleep (7-9 hours per night) for recovery and overall well-being.</li>
                            <li>Manage stress through techniques like meditation, yoga, or hobbies.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Personalized Plan Tab -->
            <div id="personalized-plan" class="tab-pane hidden">
                <div class="card">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Generate Your Personalized Fitness Plan</h2>
                    <p class="mb-6 text-gray-700 text-lg">Click the button below to generate a comprehensive fitness, nutrition, and mobility plan based on your profile.</p>
                    <button id="generate-plan-btn" class="bg-purple-600 text-white px-8 py-3 rounded-lg hover:bg-purple-700 transition-all duration-300 ease-in-out shadow-md hover:shadow-lg flex items-center justify-center">
                        <span id="generate-plan-text"><i class="fas fa-magic mr-2"></i>Generate Personalized Plan</span>
                        <div id="generate-plan-spinner" class="spinner hidden ml-2"></div>
                    </button>
                    <div id="plan-output" class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200 prose max-w-none text-gray-800 leading-relaxed">
                        <p class="text-center text-gray-600">Your personalized plan will appear here after generation.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="custom-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"></h3>
                <button class="modal-close-button" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modal-body" class="text-gray-700 text-base mb-4"></div>
            <div class="modal-footer">
                <button class="bg-blue-600 text-white px-5 py-2.5 rounded-md hover:bg-blue-700 transition-colors duration-200 shadow-sm" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId;
        let isAuthReady = false;

        // Chart instances
        let weightChartInstance;
        let bmiChartInstance;
        let bodyFatChartInstance;

        // Utility function for exponential backoff
        async function fetchWithExponentialBackoff(fetchFunction, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fetchFunction();
                } catch (error) {
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    } else {
                        throw error;
                    }
                }
            }
        }

        // Initialize Firebase and Authentication
        async function initializeFirebase() {
            try {
                // Access global variables provided by the environment
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (Object.keys(firebaseConfig).length === 0) {
                    showModal('Error', 'Firebase configuration is missing. Please ensure the environment provides __firebase_config.');
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token or anonymously
                if (initialAuthToken) {
                    await fetchWithExponentialBackoff(() => signInWithCustomToken(auth, initialAuthToken));
                } else {
                    await fetchWithExponentialBackoff(() => signInAnonymously(auth));
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('current-user-id').textContent = userId;
                        isAuthReady = true;
                        loadUserProfile();
                        setupRealtimeListeners();
                    } else {
                        document.getElementById('current-user-id').textContent = 'Not authenticated';
                        isAuthReady = false;
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                showModal('Error', `Failed to initialize Firebase or authenticate: ${error.message}`);
            }
        }

        // Custom Modal Functions
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = message;
            document.getElementById('custom-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('custom-modal').classList.add('hidden');
        }

        // Unit Conversion Functions
        function cmToInches(cm) { return cm / 2.54; }
        function inchesToCm(inches) { return inches * 2.54; }
        function kgToLbs(kg) { return kg * 2.20462; }
        function lbsToKg(lbs) { return lbs / 2.20462; }

        // Update unit labels in form
        function updateUnitLabels() {
            const units = document.getElementById('units').value;
            const heightUnit = document.getElementById('height-unit');
            const weightUnit = document.getElementById('weight-unit');
            const neckUnit = document.getElementById('neck-unit');
            const waistUnit = document.getElementById('waist-unit');
            const hipUnit = document.getElementById('hip-unit');

            if (units === 'metric') {
                heightUnit.textContent = 'cm';
                weightUnit.textContent = 'kg';
                neckUnit.textContent = 'cm';
                waistUnit.textContent = 'cm';
                hipUnit.textContent = 'cm';
            } else {
                heightUnit.textContent = 'inches';
                weightUnit.textContent = 'lbs';
                neckUnit.textContent = 'inches';
                waistUnit.textContent = 'inches';
                hipUnit.textContent = 'inches';
            }
        }

        // Event listener for unit change
        document.getElementById('units').addEventListener('change', updateUnitLabels);

        // Tab switching logic
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));

                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.remove('hidden');

                // If switching to progress tab, ensure charts are rendered/updated
                if (button.dataset.tab === 'progress') {
                    renderCharts();
                }
                // If switching to recommendations tab, update recommendations
                if (button.dataset.tab === 'recommendations') {
                    // Load user data to ensure recommendations are based on the latest saved profile
                    loadUserProfile();
                }
            });
        });

        // --- Health Calculators ---

        // BMI Calculation
        function calculateBMI(weightKg, heightCm) {
            if (weightKg <= 0 || heightCm <= 0) return null;
            const heightM = heightCm / 100;
            return weightKg / (heightM * heightM);
        }

        function getBMICategory(bmi) {
            if (bmi < 18.5) return { category: 'Underweight', risk: 'Increased' };
            if (bmi >= 18.5 && bmi <= 24.9) return { category: 'Normal weight', risk: 'Lowest' };
            if (bmi >= 25 && bmi <= 29.9) return { category: 'Overweight', risk: 'Increased' };
            if (bmi >= 30 && bmi <= 34.9) return { category: 'Obese (Class I)', risk: 'High' };
            if (bmi >= 35 && bmi <= 39.9) return { category: 'Obese (Class II)', risk: 'Very High' };
            if (bmi >= 40) return { category: 'Obese (Class III)', risk: 'Extremely High' };
            return { category: 'N/A', risk: 'N/A' };
        }

        function displayBMI(bmi) {
            const bmiResult = document.getElementById('bmi-result');
            const bmiClassification = document.getElementById('bmi-classification');
            const bmiHealthRisk = document.getElementById('bmi-health-risk');
            const bmiPointer = document.getElementById('bmi-pointer');

            if (bmi === null) {
                bmiResult.textContent = 'N/A';
                bmiClassification.textContent = 'N/A';
                bmiHealthRisk.textContent = 'N/A';
                bmiPointer.style.left = '0%';
                bmiPointer.style.backgroundColor = '#ccc';
                return;
            }

            const { category, risk } = getBMICategory(bmi);
            bmiResult.textContent = bmi.toFixed(2);
            bmiClassification.textContent = category;
            bmiHealthRisk.textContent = risk;

            // Update BMI pointer position and color
            let pointerPosition = 0;
            let pointerColor = '#ef4444'; // Default to red if outside common range

            if (bmi < 18.5) {
                pointerPosition = (bmi / 18.5) * 25; // Scale to first 25% of bar for underweight
                pointerColor = '#facc15'; // Yellow for underweight
            } else if (bmi >= 18.5 && bmi < 25) {
                pointerPosition = 25 + ((bmi - 18.5) / (25 - 18.5)) * 25; // Scale to next 25% for normal
                pointerColor = '#22c55e'; // Green for normal
            } else if (bmi >= 25 && bmi < 30) {
                pointerPosition = 50 + ((bmi - 25) / (30 - 25)) * 25; // Scale to next 25% for overweight
                pointerColor = '#fbbf24'; // Orange for overweight
            } else { // bmi >= 30 (Obese categories)
                pointerPosition = 75 + ((bmi - 30) / (40 - 30)) * 25; // Scale to last 25% for obese, up to 40
                if (bmi >= 40) pointerPosition = 100; // Cap at 100% for BMI 40+
                pointerColor = '#b91c1c'; // Darker red for obese
            }

            // Ensure pointer stays within bounds [0, 100]
            pointerPosition = Math.max(0, Math.min(100, pointerPosition));

            bmiPointer.style.left = `${pointerPosition}%`;
            bmiPointer.style.backgroundColor = pointerColor;
        }


        // Body Fat Percentage Calculation (Simplified)
        function calculateBodyFat(gender, age, heightCm, weightKg, neckCm, waistCm, hipCm) {
            if (!gender || !age || !heightCm || !weightKg || !neckCm || !waistCm) return { navy: null, jacksonPollock: null, bia: null };

            let bodyFatNavy = null;
            let bodyFatJacksonPollock = null;
            let bodyFatBIA = null;

            // All measurements in inches for Navy formula, convert if needed
            const heightIn = cmToInches(heightCm);
            const neckIn = cmToInches(neckCm);
            const waistIn = cmToInches(waistCm);
            const hipIn = gender === 'female' ? cmToInches(hipCm) : 0;

            // Navy Method
            if (gender === 'male') {
                bodyFatNavy = 86.010 * Math.log10(waistIn - neckIn) - 70.041 * Math.log10(heightIn) + 36.76;
            } else if (gender === 'female') {
                if (hipCm === null || isNaN(hipCm)) return { navy: null, jacksonPollock: null, bia: null }; // Hip required for female
                bodyFatNavy = 163.205 * Math.log10(waistIn + hipIn - neckIn) - 97.684 * Math.log10(heightIn) - 104.912;
            }

            // Jackson-Pollock (Simulated - requires skinfold measurements, here we use a proxy)
            const bmi = calculateBMI(weightKg, heightCm);
            if (bmi) {
                if (gender === 'male') {
                    bodyFatJacksonPollock = (1.20 * bmi) + (0.23 * age) - 16.2; // Simplified for general estimation
                } else { // female
                    bodyFatJacksonPollock = (1.20 * bmi) + (0.23 * age) - 5.4; // Simplified for general estimation
                }
                // Cap values to a reasonable range
                if (bodyFatJacksonPollock < 5) bodyFatJacksonPollock = 5;
                if (bodyFatJacksonPollock > 50) bodyFatJacksonPollock = 50;
            }

            // BIA Simulation (also a rough estimation based on age, gender, BMI, and a general offset)
            if (bmi) {
                if (gender === 'male') {
                    bodyFatBIA = (1.20 * bmi) + (0.23 * age) - 10.8; // General formula, not true BIA
                } else { // female
                    bodyFatBIA = (1.20 * bmi) + (0.23 * age) - 0.5; // General formula, not true BIA
                }
                // Cap values
                if (bodyFatBIA < 5) bodyFatBIA = 5;
                if (bodyFatBIA > 50) bodyFatBIA = 50;
            }

            return {
                navy: bodyFatNavy ? Math.max(0, bodyFatNavy) : null, // Ensure non-negative
                jacksonPollock: bodyFatJacksonPollock ? Math.max(0, bodyFatJacksonPollock) : null,
                bia: bodyFatBIA ? Math.max(0, bodyFatBIA) : null
            };
        }

        function displayBodyFat(bodyFatResults) {
            document.getElementById('body-fat-navy').textContent = bodyFatResults.navy !== null ? `${bodyFatResults.navy.toFixed(2)}%` : 'N/A';
            document.getElementById('body-fat-jackson-pollock').textContent = bodyFatResults.jacksonPollock !== null ? `${bodyFatResults.jacksonPollock.toFixed(2)}%` : 'N/A';
            document.getElementById('body-fat-bia').textContent = bodyFatResults.bia !== null ? `${bodyFatResults.bia.toFixed(2)}%` : 'N/A';
        }

        // Ideal Weight Calculation
        function calculateIdealWeight(gender, heightCm, units) {
            if (!gender || !heightCm) return { hamwi: null, devine: null, robinson: null, miller: null };

            const heightIn = cmToInches(heightCm); // Convert to inches for formulas

            let hamwi, devine, robinson, miller;

            // Hamwi Formula
            if (gender === 'male') {
                hamwi = 48 + 2.7 * Math.max(0, heightIn - 60); // 5 feet = 60 inches
            } else { // female
                hamwi = 45.5 + 2.2 * Math.max(0, heightIn - 60);
            }

            // Devine Formula
            if (gender === 'male') {
                devine = 50 + 2.3 * Math.max(0, heightIn - 60);
            } else { // female
                devine = 45.5 + 2.3 * Math.max(0, heightIn - 60);
            }

            // Robinson Formula
            if (gender === 'male') {
                robinson = 52 + 1.9 * Math.max(0, heightIn - 60);
            } else { // female
                robinson = 49 + 1.7 * Math.max(0, heightIn - 60);
            }

            // Miller Formula
            if (gender === 'male') {
                miller = 56.2 + 1.41 * Math.max(0, heightIn - 60);
            } else { // female
                miller = 53.1 + 1.36 * Math.max(0, heightIn - 60);
            }

            const convertToUnit = (val) => units === 'imperial' ? kgToLbs(val) : val;

            return {
                hamwi: hamwi ? convertToUnit(hamwi) : null,
                devine: devine ? convertToUnit(devine) : null,
                robinson: robinson ? convertToUnit(robinson) : null,
                miller: miller ? convertToUnit(miller) : null
            };
        }

        function displayIdealWeight(idealWeightResults, units) {
            const weightUnit = units === 'metric' ? 'kg' : 'lbs';
            document.getElementById('ideal-weight-hamwi').textContent = idealWeightResults.hamwi !== null ? `${idealWeightResults.hamwi.toFixed(1)} ${weightUnit}` : 'N/A';
            document.getElementById('ideal-weight-devine').textContent = idealWeightResults.devine !== null ? `${idealWeightResults.devine.toFixed(1)} ${weightUnit}` : 'N/A';
            document.getElementById('ideal-weight-robinson').textContent = idealWeightResults.robinson !== null ? `${idealWeightResults.robinson.toFixed(1)} ${weightUnit}` : 'N/A';
            document.getElementById('ideal-weight-miller').textContent = idealWeightResults.miller !== null ? `${idealWeightResults.miller.toFixed(1)} ${weightUnit}` : 'N/A';
        }

        // Calorie Needs Calculation
        function calculateBMR(gender, age, heightCm, weightKg, bodyFatPercent = null) {
            if (!gender || !age || !heightCm || !weightKg) return { harrisBenedict: null, mifflinStJeor: null, katchMcArdle: null };

            let harrisBenedict, mifflinStJeor, katchMcArdle = null;

            // Harris-Benedict Equation
            if (gender === 'male') {
                harrisBenedict = 66.5 + (13.75 * weightKg) + (5.003 * heightCm) - (6.755 * age);
            } else { // female
                harrisBenedict = 655.1 + (9.563 * weightKg) + (1.850 * heightCm) - (4.676 * age);
            }

            // Mifflin-St Jeor Equation
            if (gender === 'male') {
                mifflinStJeor = (10 * weightKg) + (6.25 * heightCm) - (5 * age) + 5;
            } else { // female
                mifflinStJeor = (10 * weightKg) + (6.25 * heightCm) - (5 * age) - 161;
            }

            // Katch-McArdle Equation (requires Lean Body Mass - LBM)
            if (bodyFatPercent !== null && bodyFatPercent >= 0 && bodyFatPercent <= 100) {
                const lbmKg = weightKg * (1 - (bodyFatPercent / 100));
                katchMcArdle = 370 + (21.6 * lbmKg);
            }

            return {
                harrisBenedict: harrisBenedict,
                mifflinStJeor: mifflinStJeor,
                katchMcArdle: katchMcArdle
            };
        }

        function calculateTDEE(bmr, activityLevel) {
            if (bmr === null || !activityLevel) return null;
            return bmr * parseFloat(activityLevel);
        }

        function displayCalorieNeeds(bmrResults, tdeeResult) {
            document.getElementById('bmr-harris-benedict').textContent = bmrResults.harrisBenedict !== null ? bmrResults.harrisBenedict.toFixed(0) : 'N/A';
            document.getElementById('bmr-mifflin-st-jeor').textContent = bmrResults.mifflinStJeor !== null ? bmrResults.mifflinStJeor.toFixed(0) : 'N/A';
            document.getElementById('bmr-katch-mcardle').textContent = bmrResults.katchMcArdle !== null ? bmrResults.katchMcArdle.toFixed(0) : 'N/A';
            document.getElementById('tdee-result').textContent = tdeeResult !== null ? tdeeResult.toFixed(0) : 'N/A';
        }

        // --- Data Management (Firestore) ---
        async function saveUserProfileAndMeasurements() {
            if (!isAuthReady || !userId) {
                showModal('Authentication Error', 'User not authenticated. Please wait or refresh.');
                return;
            }

            const name = document.getElementById('name').value;
            const age = parseInt(document.getElementById('age').value);
            const gender = document.getElementById('gender').value;
            const units = document.getElementById('units').value;
            let height = parseFloat(document.getElementById('height').value);
            let weight = parseFloat(document.getElementById('weight').value);
            let neck = parseFloat(document.getElementById('neck').value);
            let waist = parseFloat(document.getElementById('waist').value);
            let hip = parseFloat(document.getElementById('hip').value);
            const activityLevel = document.getElementById('activity-level').value;

            // New profile fields
            const occupation = document.getElementById('occupation').value;
            const bloodType = document.getElementById('blood-type').value;
            const fitnessGoal = document.getElementById('fitness-goal').value;
            const workoutConstraints = document.getElementById('workout-constraints').value;
            const specificConcerns = document.getElementById('specific-concerns').value;
            const workoutPreference = document.getElementById('workout-preference').value;
            const supplementsPreference = document.getElementById('supplements-preference').value;
            const workoutDays = parseInt(document.getElementById('workout-days').value);


            if (!name || !age || !gender || !height || !weight || !neck || !waist || (gender === 'female' && (isNaN(hip) || hip === 0))) {
                showModal('Input Error', 'Please fill in all required measurement fields (Name, Age, Gender, Height, Weight, Neck, Waist, and Hip for females).');
                return;
            }

            if (!occupation || !bloodType || !fitnessGoal || !workoutConstraints || !specificConcerns || !workoutPreference || !supplementsPreference || isNaN(workoutDays)) {
                showModal('Input Error', 'Please fill in all required profile details.');
                return;
            }


            // Convert all to metric for storage and calculations
            const heightCm = units === 'imperial' ? inchesToCm(height) : height;
            const weightKg = units === 'imperial' ? lbsToKg(weight) : weight;
            const neckCm = units === 'imperial' ? inchesToCm(neck) : neck;
            const waistCm = units === 'imperial' ? inchesToCm(waist) : waist;
            const hipCm = units === 'imperial' && gender === 'female' ? inchesToCm(hip) : hip;

            // Calculate metrics
            const bmi = calculateBMI(weightKg, heightCm);
            const bodyFatResults = calculateBodyFat(gender, age, heightCm, weightKg, neckCm, waistCm, hipCm);
            const idealWeightResults = calculateIdealWeight(gender, heightCm, units); // Keep units for display
            const bmrResults = calculateBMR(gender, age, heightCm, weightKg, bodyFatResults.navy);
            const tdeeResult = calculateTDEE(bmrResults.mifflinStJeor, activityLevel); // Using Mifflin for TDEE base

            const timestamp = new Date().toISOString();

            const userData = {
                name: name,
                age: age,
                gender: gender,
                units: units, // Store preferred units for display
                activityLevel: activityLevel,
                occupation: occupation,
                bloodType: bloodType,
                fitnessGoal: fitnessGoal,
                workoutConstraints: workoutConstraints,
                specificConcerns: specificConcerns,
                workoutPreference: workoutPreference,
                supplementsPreference: supplementsPreference,
                workoutDays: workoutDays,
                measurements: {
                    timestamp: timestamp,
                    heightCm: heightCm,
                    weightKg: weightKg,
                    neckCm: neckCm,
                    waistCm: waistCm,
                    hipCm: hipCm,
                    bmi: bmi,
                    bodyFatNavy: bodyFatResults.navy,
                    bodyFatJacksonPollock: bodyFatResults.jacksonPollock,
                    bodyFatBIA: bodyFatResults.bia,
                    idealWeightHamwi: idealWeightResults.hamwi,
                    idealWeightDevine: idealWeightResults.devine,
                    idealWeightRobinson: idealWeightResults.robinson,
                    idealWeightMiller: idealWeightResults.miller,
                    bmrHarrisBenedict: bmrResults.harrisBenedict,
                    bmrMifflinStJeor: bmrResults.mifflinStJeor,
                    bmrKatchMcArdle: bmrResults.katchMcArdle,
                    tdee: tdeeResult
                }
            };

            try {
                // Use a fixed document ID for the user's main profile to easily update it
                const userDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/fitness_data`, 'user_profile');
                await fetchWithExponentialBackoff(() => setDoc(userDocRef, userData, { merge: true }));

                // Add measurement to history subcollection
                const historyCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/fitness_data/user_profile/history`);
                await fetchWithExponentialBackoff(() => setDoc(doc(historyCollectionRef, timestamp), userData.measurements));

                showModal('Success', 'Your profile and measurements have been saved and updated!');
                // Re-calculate and display everything
                updateCalculatorsAndRecommendations(userData);

            } catch (error) {
                console.error("Error saving user data:", error);
                showModal('Error', `Failed to save data: ${error.message}`);
            }
        }

        async function loadUserProfile() {
            if (!isAuthReady || !userId) return;

            try {
                const userDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/fitness_data`, 'user_profile');
                const docSnap = await fetchWithExponentialBackoff(() => getDoc(userDocRef));

                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    document.getElementById('name').value = userData.name || '';
                    document.getElementById('age').value = userData.age || '';
                    document.getElementById('gender').value = userData.gender || '';
                    document.getElementById('units').value = userData.units || 'metric';
                    document.getElementById('activity-level').value = userData.activityLevel || '1.375';

                    // Load new profile fields
                    document.getElementById('occupation').value = userData.occupation || '';
                    document.getElementById('blood-type').value = userData.bloodType || '';
                    document.getElementById('fitness-goal').value = userData.fitnessGoal || '';
                    document.getElementById('workout-constraints').value = userData.workoutConstraints || '';
                    document.getElementById('specific-concerns').value = userData.specificConcerns || '';
                    document.getElementById('workout-preference').value = userData.workoutPreference || '';
                    document.getElementById('supplements-preference').value = userData.supplementsPreference || 'yes';
                    document.getElementById('workout-days').value = userData.workoutDays || '';

                    // Load personalized plan if exists
                    if (userData.personalizedPlan) {
                        document.getElementById('plan-output').innerHTML = `<pre class="whitespace-pre-wrap font-sans text-sm">${userData.personalizedPlan}</pre>`;
                    } else {
                        document.getElementById('plan-output').innerHTML = '<p class="text-center text-gray-600">Your personalized plan will appear here after generation.</p>';
                    }


                    // Use the latest measurement for display in the input form
                    if (userData.measurements) {
                        const units = userData.units || 'metric';
                        let displayHeight = userData.measurements.heightCm;
                        let displayWeight = userData.measurements.weightKg;
                        let displayNeck = userData.measurements.neckCm;
                        let displayWaist = userData.measurements.waistCm;
                        let displayHip = userData.measurements.hipCm;

                        if (units === 'imperial') {
                            displayHeight = cmToInches(displayHeight);
                            displayWeight = kgToLbs(displayWeight);
                            displayNeck = cmToInches(displayNeck);
                            displayWaist = cmToInches(displayWaist);
                            displayHip = cmToInches(displayHip);
                        }
                        document.getElementById('height').value = displayHeight ? displayHeight.toFixed(1) : '';
                        document.getElementById('weight').value = displayWeight ? displayWeight.toFixed(1) : '';
                        document.getElementById('neck').value = displayNeck ? displayNeck.toFixed(1) : '';
                        document.getElementById('waist').value = displayWaist ? displayWaist.toFixed(1) : '';
                        document.getElementById('hip').value = displayHip ? displayHip.toFixed(1) : '';
                    }
                    updateUnitLabels(); // Ensure units are correctly displayed after loading

                    // Update calculators and recommendations based on loaded data
                    updateCalculatorsAndRecommendations(userData);

                } else {
                    console.log("No user profile found, starting fresh.");
                    updateUnitLabels(); // Set initial unit labels
                }
            } catch (error) {
                console.error("Error loading user profile:", error);
                showModal('Error', `Failed to load profile: ${error.message}`);
            }
        }

        function setupRealtimeListeners() {
            if (!isAuthReady || !userId) return;

            const historyCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/fitness_data/user_profile/history`);
            // Note: orderBy is commented out as per instructions to avoid index issues.
            // Data will be sorted in JS.
            const q = query(historyCollectionRef); // , orderBy('timestamp', 'asc')

            onSnapshot(q, (snapshot) => {
                const historyData = [];
                snapshot.forEach((doc) => {
                    historyData.push(doc.data());
                });
                // Sort by timestamp manually
                historyData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                renderHistoryTable(historyData);
                renderCharts(historyData);
            }, (error) => {
                console.error("Error listening to history data:", error);
                showModal('Error', `Failed to load history: ${error.message}`);
            });
        }

        async function deleteMeasurement(timestamp) {
            if (!isAuthReady || !userId) {
                showModal('Authentication Error', 'User not authenticated.');
                return;
            }
            // Use custom modal instead of confirm
            showModal('Confirm Deletion', 'Are you sure you want to delete this measurement?');
            document.getElementById('custom-modal').querySelector('.modal-footer').innerHTML = `
                <button class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors duration-200 mr-2" onclick="confirmDelete('${timestamp}')">Delete</button>
                <button class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors duration-200" onclick="closeModal()">Cancel</button>
            `;
        }

        window.confirmDelete = async function(timestamp) {
            closeModal();
            try {
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/fitness_data/user_profile/history`, timestamp);
                await fetchWithExponentialBackoff(() => deleteDoc(docRef));
                showModal('Success', 'Measurement deleted successfully!');
            } catch (error) {
                console.error("Error deleting measurement:", error);
                showModal('Error', `Failed to delete measurement: ${error.message}`);
            }
        }

        // --- UI Update Functions ---
        function updateCalculatorsAndRecommendations(userData) {
            if (!userData || !userData.measurements) return;

            const {
                bmi,
                bodyFatNavy,
                bodyFatJacksonPollock,
                bodyFatBIA,
                idealWeightHamwi,
                idealWeightDevine,
                idealWeightRobinson,
                idealWeightMiller,
                bmrHarrisBenedict,
                bmrMifflinStJeor,
                bmrKatchMcArdle,
                tdee
            } = userData.measurements;

            const units = userData.units || 'metric';

            // Display BMI
            displayBMI(bmi);

            // Display Body Fat
            displayBodyFat({
                navy: bodyFatNavy,
                jacksonPollock: bodyFatJacksonPollock,
                bia: bodyFatBIA
            });

            // Display Ideal Weight
            displayIdealWeight({
                hamwi: idealWeightHamwi,
                devine: idealWeightDevine,
                robinson: idealWeightRobinson,
                miller: idealWeightMiller
            }, units);

            // Display Calorie Needs
            displayCalorieNeeds({
                harrisBenedict: bmrHarrisBenedict,
                mifflinStJeor: bmrMifflinStJeor,
                katchMcArdle: bmrKatchMcArdle
            }, tdee);

            // Update Recommendations
            updateRecommendations(userData);
        }

        function renderHistoryTable(historyData) {
            const tableBody = document.getElementById('history-table-body');
            tableBody.innerHTML = ''; // Clear existing rows

            if (historyData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="px-5 py-4 text-center text-gray-500">No history available. Save your first measurement!</td></tr>`;
                return;
            }

            const currentUnits = document.getElementById('units').value;

            historyData.forEach(data => {
                const date = new Date(data.timestamp).toLocaleDateString();
                const time = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                let displayWeight = data.weightKg;
                if (currentUnits === 'imperial') {
                    displayWeight = kgToLbs(displayWeight);
                }
                const weightUnit = currentUnits === 'metric' ? 'kg' : 'lbs';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-5 py-3 whitespace-nowrap text-sm text-gray-900">${date} ${time}</td>
                    <td class="px-5 py-3 whitespace-nowrap text-sm text-gray-900">${displayWeight !== null ? displayWeight.toFixed(1) : 'N/A'} ${weightUnit}</td>
                    <td class="px-5 py-3 whitespace-nowrap text-sm text-gray-900">${data.bmi !== null ? data.bmi.toFixed(2) : 'N/A'}</td>
                    <td class="px-5 py-3 whitespace-nowrap text-sm text-gray-900">${data.bodyFatNavy !== null ? data.bodyFatNavy.toFixed(2) : 'N/A'}%</td>
                    <td class="px-5 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="deleteMeasurement('${data.timestamp}')" class="text-red-600 hover:text-red-900 ml-2 p-2 rounded-md hover:bg-red-50 transition-colors duration-200">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function renderCharts(historyData = []) {
            if (historyData.length === 0) {
                // Destroy existing charts if no data
                if (weightChartInstance) weightChartInstance.destroy();
                if (bmiChartInstance) bmiChartInstance.destroy();
                if (bodyFatChartInstance) bodyFatChartInstance.destroy();
                return;
            }

            const dates = historyData.map(d => new Date(d.timestamp).toLocaleDateString());
            const weights = historyData.map(d => {
                const currentUnits = document.getElementById('units').value;
                return currentUnits === 'imperial' ? kgToLbs(d.weightKg) : d.weightKg;
            });
            const bmis = historyData.map(d => d.bmi);
            const bodyFats = historyData.map(d => d.bodyFatNavy); // Using Navy method for chart

            const weightUnit = document.getElementById('units').value === 'metric' ? 'kg' : 'lbs';

            // Chart.js global defaults for better aesthetics
            Chart.defaults.font.family = 'Inter';
            Chart.defaults.color = '#4a5568'; // gray-700
            Chart.defaults.borderColor = '#e2e8f0'; // gray-200

            const commonChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            font: {
                                size: 14,
                                weight: '600'
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: '#edf2f7' // light gray grid lines
                        }
                    }
                }
            };


            // Weight Chart
            if (weightChartInstance) weightChartInstance.destroy();
            weightChartInstance = new Chart(document.getElementById('weightChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: `Weight (${weightUnit})`,
                        data: weights,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    ...commonChartOptions,
                    scales: {
                        y: {
                            ...commonChartOptions.scales.y,
                            title: {
                                display: true,
                                text: `Weight (${weightUnit})`,
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });

            // BMI Chart
            if (bmiChartInstance) bmiChartInstance.destroy();
            bmiChartInstance = new Chart(document.getElementById('bmiChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'BMI',
                        data: bmis,
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    ...commonChartOptions,
                    scales: {
                        y: {
                            ...commonChartOptions.scales.y,
                            title: {
                                display: true,
                                text: 'BMI',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });

            // Body Fat Chart
            if (bodyFatChartInstance) bodyFatChartInstance.destroy();
            bodyFatChartInstance = new Chart(document.getElementById('bodyFatChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Body Fat (%) (Navy)',
                        data: bodyFats,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    ...commonChartOptions,
                    scales: {
                        y: {
                            ...commonChartOptions.scales.y,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Body Fat (%)',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateRecommendations(userData = null) {
            const recommendationsContent = document.getElementById('recommendations-content');
            recommendationsContent.innerHTML = ''; // Clear previous recommendations

            if (!userData || !userData.measurements) {
                recommendationsContent.innerHTML = `
                    <p>Recommendations will appear here after you save your measurements and calculations are performed.</p>
                    <p>These recommendations are based on your BMI, Body Fat Percentage, Ideal Weight, and Calorie Needs. They provide general guidance and should not replace professional medical or fitness advice.</p>
                    <h3 class="text-xl font-semibold mt-8 mb-3 text-gray-800">General Guidance:</h3>
                    <ul class="list-disc list-inside space-y-2">
                        <li>Maintain a balanced diet rich in whole foods, lean proteins, fruits, and vegetables.</li>
                        <li>Engage in regular physical activity, aiming for at least 150 minutes of moderate-intensity exercise or 75 minutes of vigorous-intensity exercise per week.</li>
                        <li>Stay hydrated by drinking plenty of water throughout the day.</li>
                        <li>Prioritize adequate sleep (7-9 hours per night) for recovery and overall well-being.</li>
                        <li>Manage stress through techniques like meditation, yoga, or hobbies.</li>
                    </ul>
                `;
                return;
            }

            const { bmi, bodyFatNavy, tdee } = userData.measurements;
            const { category: bmiCategory, risk: bmiRisk } = getBMICategory(bmi);
            const gender = userData.gender;
            const activityLevel = parseFloat(userData.activityLevel);

            let recommendationsHtml = `
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Your Current Health Snapshot:</h3>
                <ul class="list-disc list-inside space-y-2 mb-6">
                    <li><strong>BMI:</strong> ${bmi !== null ? bmi.toFixed(2) : 'N/A'} (${bmiCategory}, Health Risk: ${bmiRisk})</li>
                    <li><strong>Estimated Body Fat:</strong> ${bodyFatNavy !== null ? bodyFatNavy.toFixed(2) : 'N/A'}% (Navy Method)</li>
                    <li><strong>Estimated Daily Calorie Needs (TDEE):</strong> ${tdee !== null ? tdee.toFixed(0) : 'N/A'} kcal</li>
                </ul>
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Personalized Recommendations:</h3>
                <ul class="list-disc list-inside space-y-3">
            `;

            // BMI-based recommendations
            if (bmiCategory === 'Underweight') {
                recommendationsHtml += `<li><strong>For Underweight:</strong> Focus on nutrient-dense foods, increase healthy calorie intake gradually, and consider strength training to build muscle mass. Consult a healthcare professional or dietitian for tailored advice.</li>`;
            } else if (bmiCategory === 'Normal weight') {
                recommendationsHtml += `<li><strong>For Normal Weight:</strong> Excellent! Maintain your current healthy habits. Continue a balanced diet and regular exercise to sustain your well-being.</li>`;
            } else if (bmiCategory === 'Overweight' || bmiCategory.startsWith('Obese')) {
                recommendationsHtml += `<li><strong>For Weight Management:</strong> Aim for gradual and sustainable weight loss. Focus on creating a moderate calorie deficit through portion control, increasing physical activity, and prioritizing whole, unprocessed foods. Incorporate a mix of cardiovascular exercise and strength training. Consider consulting a healthcare professional or dietitian for a personalized plan.</li>`;
            }

            // Body Fat based recommendations (general ranges for men/women)
            if (bodyFatNavy !== null) {
                if (gender === 'male') {
                    if (bodyFatNavy < 6) recommendationsHtml += `<li><strong>Body Fat (Male):</strong> Your body fat percentage is very low. Ensure adequate fat intake for hormonal health and overall energy.</li>`;
                    else if (bodyFatNavy >= 6 && bodyFatNavy <= 17) recommendationsHtml += `<li><strong>Body Fat (Male):</strong> Your body fat percentage is within a healthy range. Continue your current healthy lifestyle.</li>`;
                    else if (bodyFatNavy > 17 && bodyFatNavy <= 25) recommendationsHtml += `<li><strong>Body Fat (Male):</strong> Your body fat percentage is slightly elevated. Focus on body recomposition by increasing muscle mass and reducing fat through strength training and a balanced diet.</li>`;
                    else if (bodyFatNavy > 25) recommendationsHtml += `<li><strong>Body Fat (Male):</strong> Your body fat percentage is high. Prioritize sustainable fat loss strategies, including regular exercise and a controlled calorie intake.</li>`;
                } else { // female
                    if (bodyFatNavy < 14) recommendationsHtml += `<li><strong>Body Fat (Female):</strong> Your body fat percentage is very low. Ensure adequate fat intake for hormonal health and overall vitality.</li>`;
                    else if (bodyFatNavy >= 14 && bodyFatNavy <= 24) recommendationsHtml += `<li><strong>Body Fat (Female):</strong> Your body fat percentage is within a healthy range. Continue your current healthy lifestyle.</li>`;
                    else if (bodyFatNavy > 24 && bodyFatNavy <= 31) recommendationsHtml += `<li><strong>Body Fat (Female):</strong> Your body fat percentage is slightly elevated. Focus on body recomposition by increasing muscle mass and reducing fat through strength training and a balanced diet.</li>`;
                    else if (bodyFatNavy > 31) recommendationsHtml += `<li><strong>Body Fat (Female):</strong> Your body fat percentage is high. Prioritize sustainable fat loss strategies, including regular exercise and a controlled calorie intake.</li>`;
                }
            }

            // Calorie needs and activity level recommendations
            if (tdee !== null) {
                recommendationsHtml += `<li><strong>Nutrition:</strong> Your estimated daily calorie need is around ${tdee.toFixed(0)} kcal. Adjust your intake based on your specific goals (e.g., a moderate deficit for weight loss, a slight surplus for muscle gain). Focus on whole, unprocessed foods, lean proteins, and complex carbohydrates.</li>`;
            }
            if (activityLevel < 1.55) { // Sedentary or Lightly Active
                recommendationsHtml += `<li><strong>Activity:</strong> Consider gradually increasing your physical activity levels. Aim for at least 30 minutes of moderate-intensity exercise most days of the week. Incorporate more non-exercise activity throughout your day, such as walking or taking the stairs.</li>`;
            } else {
                recommendationsHtml += `<li><strong>Activity:</strong> You are maintaining a good activity level. Continue to challenge yourself and vary your workouts to prevent plateaus and ensure continued progress.</li>`;
            }

            recommendationsHtml += `
                </ul>
                <h3 class="text-xl font-semibold mt-8 mb-3 text-gray-800">Important Considerations:</h3>
                <ul class="list-disc list-inside space-y-2">
                    <li>These recommendations are general guidelines. For personalized and medically safe advice, always consult a doctor, registered dietitian, or certified personal trainer.</li>
                    <li>Listen to your body. Prioritize rest and recovery, and avoid overtraining to prevent injuries.</li>
                    <li>Consistency is key. Small, sustainable changes adopted over time lead to the most significant and lasting results.</li>
                    <li>Hydration is crucial for all bodily functions and performance. Drink plenty of water throughout the day.</li>
                    <li>Ensure adequate sleep (7-9 hours per night) for optimal physical and mental recovery and overall well-being.</li>
                </ul>
            `;
            recommendationsContent.innerHTML = recommendationsHtml;
        }

        // --- PDF Report Generation ---
        document.getElementById('generate-pdf-btn').addEventListener('click', async () => {
            if (!isAuthReady || !userId) {
                showModal('Authentication Required', 'Please ensure you are authenticated to generate a report.');
                return;
            }

            try {
                const userDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/fitness_data`, 'user_profile');
                const docSnap = await fetchWithExponentialBackoff(() => getDoc(userDocRef));

                if (!docSnap.exists() || !docSnap.data().measurements) {
                    showModal('No Data', 'No user data or measurements found to generate a report. Please save your profile first.');
                    return;
                }

                const userData = docSnap.data();
                const latestMeasurement = userData.measurements;
                const historyCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/fitness_data/user_profile/history`);
                const historySnapshot = await fetchWithExponentialBackoff(() => getDocs(query(historyCollectionRef)));
                const historyData = [];
                historySnapshot.forEach(doc => historyData.push(doc.data()));
                historyData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); // Sort by date

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(22);
                doc.text("Personal Fitness Report", 105, 20, null, null, "center");

                doc.setFontSize(12);
                doc.text(`Report Date: ${new Date().toLocaleDateString()}`, 14, 30);
                doc.text(`User ID: ${userId}`, 14, 37);
                doc.text(`Name: ${userData.name || 'N/A'}`, 14, 44);
                doc.text(`Age: ${userData.age || 'N/A'}`, 14, 51);
                doc.text(`Gender: ${userData.gender || 'N/A'}`, 14, 58);
                doc.text(`Preferred Units: ${userData.units || 'N/A'}`, 14, 65);
                doc.text(`Activity Level: ${document.getElementById('activity-level').options[document.getElementById('activity-level').selectedIndex].text || 'N/A'}`, 14, 72);
                doc.text(`Occupation: ${userData.occupation || 'N/A'}`, 14, 79);
                doc.text(`Blood Type: ${userData.bloodType || 'N/A'}`, 14, 86);
                doc.text(`Fitness Goal: ${userData.fitnessGoal || 'N/A'}`, 14, 93);
                doc.text(`Workout Constraints: ${userData.workoutConstraints || 'N/A'}`, 14, 100);
                doc.text(`Specific Concerns: ${userData.specificConcerns || 'N/A'}`, 14, 107);
                doc.text(`Workout Preference: ${userData.workoutPreference || 'N/A'}`, 14, 114);
                doc.text(`Open to Supplements: ${userData.supplementsPreference || 'N/A'}`, 14, 121);
                doc.text(`Workout Days per Week: ${userData.workoutDays || 'N/A'}`, 14, 128);


                doc.setFontSize(16);
                doc.text("Latest Measurements & Calculations", 14, 140);
                doc.setFontSize(10);

                const currentUnits = userData.units || 'metric';
                const weightUnit = currentUnits === 'metric' ? 'kg' : 'lbs';
                const heightUnit = currentUnits === 'metric' ? 'cm' : 'inches';

                const latestData = [
                    ["Metric", "Value", "Unit"],
                    ["Height", currentUnits === 'imperial' ? cmToInches(latestMeasurement.heightCm).toFixed(1) : latestMeasurement.heightCm.toFixed(1), heightUnit],
                    ["Weight", currentUnits === 'imperial' ? kgToLbs(latestMeasurement.weightKg).toFixed(1) : latestMeasurement.weightKg.toFixed(1), weightUnit],
                    ["Neck", currentUnits === 'imperial' ? cmToInches(latestMeasurement.neckCm).toFixed(1) : latestMeasurement.neckCm.toFixed(1), heightUnit],
                    ["Waist", currentUnits === 'imperial' ? cmToInches(latestMeasurement.waistCm).toFixed(1) : latestMeasurement.waistCm.toFixed(1), heightUnit],
                    ["Hip", latestMeasurement.hipCm !== null ? (currentUnits === 'imperial' ? cmToInches(latestMeasurement.hipCm).toFixed(1) : latestMeasurement.hipCm.toFixed(1)) : 'N/A', heightUnit],
                    ["BMI", latestMeasurement.bmi !== null ? latestMeasurement.bmi.toFixed(2) : 'N/A', ''],
                    ["BMI Classification", getBMICategory(latestMeasurement.bmi).category, ''],
                    ["BMI Health Risk", getBMICategory(latestMeasurement.bmi).risk, ''],
                    ["Body Fat (Navy)", latestMeasurement.bodyFatNavy !== null ? latestMeasurement.bodyFatNavy.toFixed(2) : 'N/A', '%'],
                    ["Body Fat (Jackson-Pollock Sim.)", latestMeasurement.bodyFatJacksonPollock !== null ? latestMeasurement.bodyFatJacksonPollock.toFixed(2) : 'N/A', '%'],
                    ["Body Fat (BIA Sim.)", latestMeasurement.bodyFatsBIA !== null ? latestMeasurement.bodyFatBIA.toFixed(2) : 'N/A', '%'],
                    ["Ideal Weight (Hamwi)", latestMeasurement.idealWeightHamwi !== null ? latestMeasurement.idealWeightHamwi.toFixed(1) : 'N/A', weightUnit],
                    ["Ideal Weight (Devine)", latestMeasurement.idealWeightDevine !== null ? latestMeasurement.idealWeightDevine.toFixed(1) : 'N/A', weightUnit],
                    ["Ideal Weight (Robinson)", latestMeasurement.idealWeightRobinson !== null ? latestMeasurement.idealWeightRobinson.toFixed(1) : 'N/A', weightUnit],
                    ["Ideal Weight (Miller)", latestMeasurement.idealWeightMiller !== null ? latestMeasurement.idealWeightMiller.toFixed(1) : 'N/A', weightUnit],
                    ["BMR (Harris-Benedict)", latestMeasurement.bmrHarrisBenedict !== null ? latestMeasurement.bmrHarrisBenedict.toFixed(0) : 'N/A', 'kcal/day'],
                    ["BMR (Mifflin-St Jeor)", latestMeasurement.bmrMifflinStJeor !== null ? latestMeasurement.bmrMifflinStJeor.toFixed(0) : 'N/A', 'kcal/day'],
                    ["BMR (Katch-McArdle)", latestMeasurement.bmrKatchMcArdle !== null ? latestMeasurement.bmrKatchMcArdle.toFixed(0) : 'N/A', 'kcal/day'],
                    ["TDEE", latestMeasurement.tdee !== null ? latestMeasurement.tdee.toFixed(0) : 'N/A', 'kcal/day']
                ];

                doc.autoTable({
                    startY: 145,
                    head: [latestData[0]],
                    body: latestData.slice(1),
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [200, 220, 255], textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [240, 240, 240] }
                });

                let finalY = doc.autoTable.previous.finalY + 10;

                doc.addPage();
                doc.setFontSize(16);
                doc.text("Measurement History", 14, 20);
                doc.setFontSize(10);

                const historyTableData = [
                    ["Date", `Weight (${weightUnit})`, "BMI", "Body Fat (%) (Navy)"]
                ];
                historyData.forEach(data => {
                    const date = new Date(data.timestamp).toLocaleDateString();
                    let displayWeight = data.weightKg;
                    if (currentUnits === 'imperial') {
                        displayWeight = kgToLbs(displayWeight);
                    }
                    historyTableData.push([
                        date,
                        displayWeight !== null ? displayWeight.toFixed(1) : 'N/A',
                        data.bmi !== null ? data.bmi.toFixed(2) : 'N/A',
                        data.bodyFatNavy !== null ? data.bodyFatNavy.toFixed(2) : 'N/A'
                    ]);
                });

                doc.autoTable({
                    startY: 25,
                    head: [historyTableData[0]],
                    body: historyTableData.slice(1),
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [200, 220, 255], textColor: [0, 0, 0] },
                    alternateRowStyles: { fillColor: [240, 240, 240] }
                });

                finalY = doc.autoTable.previous.finalY + 10;

                // Add recommendations to PDF
                doc.addPage();
                doc.setFontSize(16);
                doc.text("Personalized Recommendations", 14, 20);
                doc.setFontSize(10);

                const recommendationsText = document.getElementById('recommendations-content').innerText;
                const splitText = doc.splitTextToSize(recommendationsText, 180); // Max width 180mm
                doc.text(splitText, 14, 30);

                // Add Personalized Plan to PDF if available
                const planOutput = document.getElementById('plan-output').innerText;
                if (planOutput && !planOutput.includes("Your personalized plan will appear here.")) {
                    doc.addPage();
                    doc.setFontSize(16);
                    doc.text("Personalized Fitness Plan", 14, 20);
                    doc.setFontSize(10);
                    const splitPlanText = doc.splitTextToSize(planOutput, 180);
                    doc.text(splitPlanText, 14, 30);
                }


                doc.save('Fitness_Report.pdf');
                showModal('Report Generated', 'Your PDF fitness report has been generated and downloaded!');

            } catch (error) {
                console.error("Error generating PDF:", error);
                showModal('Error', `Failed to generate PDF report: ${error.message}`);
            }
        });

        // --- Personalized Plan Generation (LLM Integration) ---
        document.getElementById('generate-plan-btn').addEventListener('click', async () => {
            if (!isAuthReady || !userId) {
                showModal('Authentication Required', 'Please ensure you are authenticated and have saved your profile to generate a plan.');
                return;
            }

            const generateButton = document.getElementById('generate-plan-btn');
            const generateText = document.getElementById('generate-plan-text');
            const spinner = document.getElementById('generate-plan-spinner');
            const planOutput = document.getElementById('plan-output');

            generateButton.disabled = true;
            generateText.classList.add('hidden');
            spinner.classList.remove('hidden');
            planOutput.innerHTML = '<p class="text-center text-gray-500">Generating your personalized plan... This may take a moment.</p>';

            try {
                const userDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/fitness_data`, 'user_profile');
                const docSnap = await fetchWithExponentialBackoff(() => getDoc(userDocRef));

                if (!docSnap.exists()) {
                    showModal('Profile Missing', 'Please save your profile details in the "User Input" tab first.');
                    planOutput.innerHTML = '<p class="text-red-500">Please save your profile details first.</p>';
                    return;
                }

                const userData = docSnap.data();
                const {
                    age, gender, occupation, heightCm, weightKg, bloodType, fitnessGoal,
                    workoutConstraints, specificConcerns, workoutPreference, supplementsPreference, workoutDays
                } = userData;

                if (!age || !gender || !occupation || !heightCm || !weightKg || !bloodType || !fitnessGoal ||
                    !workoutConstraints || !specificConcerns || !workoutPreference || !supplementsPreference || !workoutDays) {
                    showModal('Incomplete Profile', 'Please fill in all profile details in the "User Input" tab before generating a personalized plan.');
                    planOutput.innerHTML = '<p class="text-red-500">Please complete your profile details first.</p>';
                    return;
                }

                const prompt = `
                    Act as a personal trainer. Devise a comprehensive fitness, nutrition, and mobility plan for the following individual. Use your knowledge of exercise science and nutrition advice.

                    Client Profile:
                    Age: ${age}
                    Gender: ${gender}
                    Occupation: ${occupation}
                    Height: ${heightCm} cm
                    Weight: ${weightKg} kg
                    Blood type: ${bloodType}
                    Goal: ${fitnessGoal}
                    Workout constraints: ${workoutConstraints}
                    Specific concerns: ${specificConcerns}
                    Workout preference: ${workoutPreference}
                    Open to supplements: ${supplementsPreference}

                    Please design a comprehensive plan that includes:
                    1.  A detailed ${workoutDays}-day weekly workout regimen with specific exercises, sets, reps, and rest periods. Include warm-up and cool-down.
                    2.  A sustainable nutrition plan that supports the goal and considers the client’s blood type (provide general dietary guidelines, not strict meal plans, unless blood type has specific, widely accepted implications).
                    3.  Appropriate supplement recommendations (if applicable and if the client is open to them).
                    4.  Techniques and exercises to address ${specificConcerns}.
                    5.  Daily movement or mobility strategies for a remote worker to stay active and offset sitting.
                    6.  Simple tracking metrics for monitoring progress.
                    7.  Provide practical implementation guidance that fits into a remote worker’s routine, emphasizing sustainability, proper form, and injury prevention.

                    Format the response clearly with headings for each section.
                `;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will provide this at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetchWithExponentialBackoff(() => fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const planText = result.candidates[0].content.parts[0].text;
                    planOutput.innerHTML = `<pre class="whitespace-pre-wrap font-sans text-sm">${planText}</pre>`;

                    // Save the generated plan to Firestore
                    const userDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/fitness_data`, 'user_profile');
                    await fetchWithExponentialBackoff(() => setDoc(userDocRef, { personalizedPlan: planText }, { merge: true }));

                } else {
                    planOutput.innerHTML = '<p class="text-red-500">Failed to generate plan. Please try again.</p>';
                    console.error("LLM response structure unexpected:", result);
                }

            } catch (error) {
                console.error("Error generating personalized plan:", error);
                planOutput.innerHTML = `<p class="text-red-500">An error occurred: ${error.message}. Please ensure your profile is complete and try again.</p>`;
            } finally {
                generateButton.disabled = false;
                generateText.classList.remove('hidden');
                spinner.classList.add('hidden');
                // Restore default modal footer
                document.getElementById('custom-modal').querySelector('.modal-footer').innerHTML = `
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors duration-200" onclick="closeModal()">OK</button>
                `;
            }
        });


        // Event listener for form submission
        document.getElementById('user-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveUserProfileAndMeasurements();
        });

        // Event listener for gender change to show/hide hip input
        document.getElementById('gender').addEventListener('change', (e) => {
            const hipInputGroup = document.getElementById('hip-input-group');
            if (e.target.value === 'female') {
                hipInputGroup.classList.remove('hidden');
            } else {
                hipInputGroup.classList.add('hidden');
                document.getElementById('hip').value = ''; // Clear hip value if not female
            }
        });

        // Initialize on window load
        window.onload = function () {
            initializeFirebase();
            updateUnitLabels(); // Initial call to set correct unit labels
            // Trigger gender change listener once on load to set initial hip input visibility
            document.getElementById('gender').dispatchEvent(new Event('change'));
        };

        // Expose functions to global scope for HTML inline calls (e.g., deleteMeasurement)
        window.deleteMeasurement = deleteMeasurement;
        window.showModal = showModal;
        window.closeModal = closeModal;

    </script>
</body>
</html>
